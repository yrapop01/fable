<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Yuri Rapoport">
    <link rel="icon" href="images/favicon.ico">

    <title>Fable</title>

    <!-- External Libraries -->
    <script src="extern/jQuery/jquery.min.js"></script>
    <link href="extern/Bootstrap/bootstrap.min.css" rel="stylesheet">
    <script src="extern/Bootstrap/bootstrap.min.js"></script>
    <link href="extern/highlight.js/highlight.min.css" rel="stylesheet">
    <link href="extern/highlight.js/gruvbox-light.css" rel="stylesheet">
    <script src="extern/highlight.js/highlight.min.js"></script>

    <!-- Major Imports -->
    <script src="js/editor.js"></script>
    <script src="js/notebook.js"></script>

    <style>
        h4 {
            display: inline !important;
        }
        h4, h1, .logo {
            font-family: 'Berkshire Swash', cursive;
        }
        .logo > img {
            height: 1em;
        }
        nav > ul { display: table; width: 100%; margin: 0; padding: 0}
        nav > ul > li { display: table-cell; float: none;
                        padding-left: 3px; padding-right: 3px }
        .icon-flipped {
            transform: scaleX(-1);
            -moz-transform: scaleX(-1);
            -webkit-transform: scaleX(-1);
            -ms-transform: scaleX(-1);
        }
        .hidden {
            display: none;
        }
        .fable-disconnected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .controls-bg {
            background: #fefefd;
            background: linear-gradient(to bottom, #fefefd 0%,#dce3c4 42%,#aebf76 100%);
            background: rgb(254,255,232);
            background: linear-gradient(to bottom, rgba(254,255,232,1) 0%,rgba(214,219,191,1) 100%); 
            /*background: #feffe8;
            background: linear-gradient(to bottom, rgba(255,255,255,1) 0%,rgba(229,229,229,1) 100%);*/
        }
    </style>

  </head>

  <body>
    <div id="fable-disconnected" class="hidden fabe-disconnected">
        <img src="images/logo_small.png" alt="fable"></img>
        <h1>Disconnected :(</h1>
    </div>
    <div id="fable-connected" class="hidden">
       <div class="container"><div class="controls-bg" style="border: 1px solid; border-color: silver; font-size: x-small !important; display: flex; border-top-left-radius: 5px; border-top-right-radius: 5px; justify-content: space-between; margin-bottom: 5px; margin-top: 5px">
            <span>
            <a href="/index.html" target='_blank' type="button" class="btn btn-sm btn-outline-primary">
              <span class="glyphicon glyphicon-grain"></span> New
            </a>
            <a href="#" type="button" class="btn btn-sm btn-outline-primary" id="fable-duplicate">
              <span class="glyphicon glyphicon-duplicate"></span> Duplicate
            </a>
            <a href="#" type="button" class="btn btn-sm btn-outline-primary" id="fable-undo">
              <span class="glyphicon glyphicon-share-alt icon-flipped"></span> Undo
            </a>
            <a href="#" type="button" class="btn btn-sm btn-outline-primary" id="fable-redo">
              <span class="glyphicon glyphicon-share-alt"></span> Redo
            </a>
            <a href="#" type="button" class="btn btn-sm btn-outline-primary" id="fable-publish">
              <span class="glyphicon glyphicon-bullhorn"></span> Publish
            </a>
            <a href="#" type="button" class="btn btn-sm btn-outline-primary"
               onclick="this.blur();">
              <span class="glyphicon glyphicon-retweet"></span> Restart
            </a>
            <a href="#" type="button" class="btn btn-sm btn-outline-primary"
               onclick="this.blur();">
              <span class="glyphicon glyphicon-cloud-upload"></span> Save
            </a>
            </span>
            <span>
            <a href="#" type="button" class="btn btn-sm btn-outline-primary"
               onclick="this.blur();">
                /home/yuri/sample.fab
            </a>
            </span>
        </div></div>


    <div class="container" id="container">
        <script>
            function Tasks() {
                var self = {tasks: [], current: null};

                self.add = function(cell) {
                    if (cell.state != 'Idle') {
                        console.log('Error: cannot execute non-idle cell');
                        return;
                    }
                    cell.change_status('Waiting');
                    self.tasks.push([cell, cell.code()]);
                };

                self.shift = function() {
                    if (self.current) {
                        console.log('Waiting for an old task to finish');
                        return null;
                    }
                    if (self.tasks.length == 0) {
                        console.log('No more tasks to run');
                        return null;
                    }
                    self.current = self.tasks.shift();
                    self.current[0].change_status('Sending');
                    return {ids: self.current[0].guid, code: self.current[1]};
                };

                self.started = function(guid) {
                    if (!self.current || guid != self.current[0].guid) {
                        console.log('ERROR: Running a cell not scheduled for execution');
                        return;
                    }
                    self.current[0].change_status('Running');
                };

                self.ended = function(guid) {
                    if (!self.current || guid != self.current[0].guid) {
                        console.log('ERROR: Run a cell not scheduled for execution');
                        return;
                    }
                    self.current[0].change_status('Idle');
                    self.current = null;
                };

                self.remove = function(guid) {
                    var i;
                    if (self.current && guid == self.current[0].guid) {
                        self.current[0].change_status('Stopping');
                        return false;
                    }
                    for (i in self.tasks) {
                        if (self.tasks[i][0].guid == guid)
                            break;
                    }
                    if (!i || i == self.tasks.length) {
                        console.log('ERROR: Trying to remove unknown task');
                        return true;
                    }
                    console.log(i);
                    self.tasks[i][0].change_status('Idle');
                    self.tasks.splice(i, 1);
                    return true;
                }

                self.override_running = function(cell) {
                    if (self.current) {
                        console.log('ERROR: Already running another cell');
                        return;
                    }

                    self.current = [cell, cell.code];
                    self.current[0].change_status('Running');
                }

                return self;
            }

            function Connection() {
                var self = {events: {}, messages: []};

                self.open = function() {
                    let domain = document.domain;
                    let path = location.pathname.split("/").slice(0, -1).join("/") + "/conn";
                    let port = location.port;
                    let url = "ws://" + domain + ":" + port + path;
                    self.ws = new WebSocket(url);

                    self.ws.onopen = function(event) {
                        self.onopen(event);
                    };
 
                    self.ws.onmessage = function(event) {
                        self.onmessage(event);
                    };

                    self.ws.onclose = function(event) {
                        self.onclose(event);
                    };

                    self.ws.onerror = function(event) {
                        console.log('ws error occured');
                    }
                };

                self.send = function(obj) {
                    self.ws.send(JSON.stringify(obj));
                }

                self.onopen = function(event) {
                    let params = (new URL(document.location)).searchParams;
                    var action = {
                        name: params.has('name') ? params.get('name') : ''
                    };
                    if (params.has('force'))
                        action.force = Boolean(params.get('force'));
                    self.send(['notebook', action]);
                };

                self.onclose = function(event) {
                    if (self.events.disconnected)
                        self.events.disconnected();
                };

                self.onmessage = function(event) {
                        let data = JSON.parse(event.data);
                        let code = data['code'];
                        let value = data['value'];

                        if (code in self.events)
                            self.events[code](value);
                };

                return self;
            }

            var notebook = Notebook(document.getElementById('container'), {});
            var conn = Connection();
            var tasks = Tasks();

            function submit() {
                var current = tasks.shift();
                if (current)
                    conn.send(["run", current]);
            }

            function output(text, cls) {
                return "<span class=\"" + cls +"\" style=\"white-space: pre\">" + text + "</span>";
            }

            function format(outputs) {
                var out = "";
                for (var i in outputs) {
                    let key = outputs[i][0];
                    let value = outputs[i][1];

                    if (key == "err")
                        out += output(value, "text-danger");
                    else if (key == "out")
                        out += output(value, "text-primary");
                    else if (key == "html")
                        out += value;
                    else if (key == "section")
                        out += "<h4>" + value + "</h4>";
                    else if (key == "subsection")
                        out += value;
                }
                return out;
            }

            conn.events.opened = function(value) {
                let cells = value['cells'];
                let running = value['running'];

                document.getElementById("fable-disconnected").classList.add("hidden");
                document.getElementById("fable-connected").classList.remove("hidden");

                if (!cells.length) {
                    notebook.build();
                    return;
                }

                var cell = null;
                for (var i in cells) {
                    let desc = cells[i];
                    let guid = desc['guid'];

                    if (!cell)
                        cell = notebook.build(guid);
                    else
                        cell = cell.append(cell, guid);

                    cell.putCode(desc['data']);
                    cell.write(format(desc['out']));
                    //cell.change_kind(desc['kind']);
                }

                if (running)
                    tasks.override_running(notebook.cells[running]);
            }

            conn.events.code_run = function(value) {
                let guid = value["ids"];
                let msgs = value["msg"];

                if (!(guid in notebook.cells)) {
                    console.log('ERROR: printing to unknown cell');
                    return;
                }

                for (var i in msgs) {
                    let msg = msgs[i];
                    let key = msg[0];

                    if (key == "started") {
                        tasks.started(guid);
                        continue;
                    }

                    if (key == "ended") {
                        tasks.ended(guid);
                        continue;
                    }

                    var out = format([msg]);
                    console.log('output', out);
                    if (out)
                       notebook.cells[guid].write(out);
                }
            };

            conn.events.kind_changed = function(value) {
                let guid = value['guid'];
                let kind = value['kind'];
                
                notebook.cells[guid].change_kind(kind);
            };

            conn.events.disconnected = function() {
                notebook.destroy();
                document.getElementById("fable-connected").classList.add("hidden");
                document.getElementById("fable-disconnected").classList.remove("hidden");
            };

            notebook.events.submit = function(s) { 
                s.clear();
                tasks.add(s);
                conn.send(["change", {guid: s.guid, code: s.code()}]);
                submit();
            };

            notebook.events.interrupt = function(s) {
                if (!tasks.remove(s.guid))
                    conn.send(["interrupt", null]);
            };

            notebook.events.newcell = function(prev_id, cell_id) {
                conn.send(["newcell", {prev_id: prev_id, cell_id: cell_id}]);
            }

            conn.open();
        </script>
        <div class="logo" style="border-top: 0px solid; border-color: silver; text-align: right; font-size: x-small; color: silver; margin-top: 1em">
        Fable | Version 1.0
        </div>
    </div>
    </div>
  </body>
</html>
